<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Watchアプリをリリースしていました - Wantedly Engineer Blog</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/favicon-8030cb16.png" rel="icon" type="image/png">
    <meta property="fb:app_id" content="234170156611754">
    <meta property="og:image" content="https://cloud.githubusercontent.com/assets/43811/14939451/788cd39e-0f82-11e6-82ea-4621b7606fb5.png">
    <link href="/stylesheets/application-b5fca3c2.css" media="screen" rel="stylesheet" type="text/css" />
    <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12847756-21']);
    _gaq.push(['_setDomainName', 'wantedly.com']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </head>
  <body>
    <header class="jumbotron cover-image center">
      <h1 class="graduate"><a href="https://www.wantedly.com/feed/s/wantedly_engineers">Wantedly Engineer Blog</a></h1>
      <p>Wantedly 開発チームブログ</p>
    </header>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8">
          <a href="https://www.wantedly.com/feed/s/wantedly_engineers" style="font-size: 20px;" alt="Wantedly Engineer Blog">Wantedly Engineer Blogは移転しました</a>
            <div class="page-header clearfix">
    <h2>
      <div class="article-title">
        Apple Watchアプリをリリースしていました
      </div>
    </h2>
    <div class="article-avatar">
      <a href="https://www.wantedly.com/users/300507">
        <img src="https://www.wantedly.com/users/300507/avatar" class="avatar" />
      </a>
      <span class='date'>30-Apr-2016</span>
    </div>
    <div class="pull-right social-links">
      <iframe src="//www.facebook.com/plugins/like.php?href=http://engineer.wantedly.com/2016/04/30/watch-app.html&amp;width=80&amp;layout=button_count&amp;action=like&amp;show_faces=false&amp;share=false&amp;height=20&amp;appId=234170156611754", scrolling="no", frameborder="0", style="border:none; overflow:hidden; width:110px; height:20px;", allowTransparency="true"></iframe>
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="_shingt" data-url="http://engineer.wantedly.com/2016/04/30/watch-app.html">Tweet</a>
      <a href="http://b.hatena.ne.jp/entry/http://engineer.wantedly.com/2016/04/30/watch-app.html" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
      
        <iframe src="http://ghbtns.com/github-btn.html?user=shingt&amp;type=follow&amp;count=true"
  allowtransparency="true" frameborder="0" scrolling="0" width="165" height="20"></iframe>
      
    </div>
  </div>
  <div class="article">
    <p>エンジニアのshingtです。このblogを書くのは2年前に<a href="/2014/01/02/neo4j-introduction.html">Neo4jの記事</a>を書いて以来ですね。</p>

<p>さて、時期を少し逃してしまった感がありますが、3月にWantedlyのApple Watch用アプリをこっそりリリースしました。</p>

<p>このアプリには少し変わった機能として &ldquo;Wantedly上に登録された企業が近くにある際に、その企業を通知・表示する&rdquo; というものを入れています。（注: 通知候補は一部の企業様のみとなっております。）</p>

<p>設計としても多少変わったものになったため、簡単にですがここで紹介します（自分の備忘録も兼ねて）。なお、watchOS 2、iOS9上での開発です。</p>

<h2>機能について</h2>

<p>前述のように、このWatchアプリではユーザの近くにある企業を通知/表示することができます。
このフローは大きく分けて2つ存在しており、画面遷移は以下のようになっています。
通知もしくは起動時の画面から、最終的には同じ位置情報を表示する画面に行き着く、という構成です。</p>

<p><img src="/images/2016-04-30/image1-2527cc6a.png" width=600px></p>

<p>メッセージが確認できる画面等もありますが、機能としてはそれくらいで、watchOSのドキュメントや<a href="http://nerds.airbnb.com/airbnb-watch/">airbnbのblogなどで言われるように</a>、本体アプリの&ldquo;Lightweight Extension&quot;となるような機能に留めつつ、watchらしい体験も組み込んだという形です。</p>

<h2>位置情報取得周りのフロー</h2>

<p>上の図の通り、このアプリでは位置情報をユーザが確認するフローが2つ存在しています。</p>

<ul>
<li>フローA: 通知経由の場合</li>
<li>フローB: ユーザが自らアプリを起動した場合</li>
</ul>

<h3>フローA: 通知経由の場合</h3>

<p>前提としてこのアプリの通知は頻繁に送る類のものではありません。
そのため、<code>CLLocationManager</code>における<a href="https://developer.apple.com/library/ios/documentation/CoreLocation/Reference/CLLocationManager_Class/index.html#//apple_ref/doc/uid/TP40007125-CH3-SW60">Significant Location Change</a>が検出されたタイミングで、一定条件を満たしている場合のみ通知を送信する、という方針を選択しました。</p>

<p>シーケンス図として正確ではありませんが、大まかな流れは以下のようになります。</p>

<p><img src="/images/2016-04-30/image2-2a3ac67f.png" width=600px></p>

<p>位置情報画面に移動してからは、watchOSの<code>CLLocationManager</code>が持つ<code>requestLocation</code>を利用してiOS側に位置情報を問い合わせ、定期的に画面中の距離情報や地図をアップデートします。
（Apple WatchにはGPSが内蔵されていないため、iOS側に問い合わせない限り位置情報を得ることはできません。）</p>

<p>この際の位置情報取得はiOS側で引き続き行い、それをwatchOS側で渡す流れにすることも可能でした。
そうしなかったのは以下の理由からです。</p>

<ul>
<li><code>requestLocation</code>を利用すればそれ以降の位置情報に関するコードはwatchOS側で完結させることができる</li>
<li>要件として<code>CLLocationManager</code>の精度としては最高のもの（<code>kCLLocationAccuracyBestForNavigation</code>）を利用する必要があり、例えばハンドリングのバグ起因でiOS側で位置情報の取得が誤って行われている（= iOSデバイスのバッテリーの消費が大きくなってしまう）という状況は絶対に避けたかった</li>
</ul>

<p>あくまでwatchOSアプリはエクステンションと捉えており、iOSアプリ側に影響が出ることは基本的に無いように設計していました。もちろん、Apple Watchとのペアリングが行われていない端末であれば、そもそも位置情報の取得許可を得ることもありません。</p>

<h3>フローB: ユーザが自らアプリを起動した場合</h3>

<p>こちらはユーザが通常通りApple Watch上でアプリを起動したケースです。</p>

<p><img src="/images/2016-04-30/image3-77b3cc6c.png" width=600px></p>

<p>先ほどよりやや複雑ですね。一度近くの企業情報を取得した後の挙動はプロセス1の場合と同様です。</p>

<p>当初はwatchOSがiOSに対して<code>requestLocation</code>を発行し、その結果を受け取った後、再度近くの企業を取得するリクエストを発行するという方針で考えていました。
しかしこの場合、コードとしては単純に記述できるものの、watchOS &lt;=&gt; iOS間のやり取りが上記の図よりも余分に一度増えてしまいます。</p>

<p>そのためwatchOSからiOSへの問い合わせについて、図のように<code>WCSession</code>を利用して近くの企業自体をリクエストするようにし、現在地の取得はiOS上で行うようにしました。<code>WCSession</code>はデバッグし辛かったりシミュレータ上で不安定だったりと少し扱い辛くもありましたが、実機上ではある程度安定していたように思います。</p>

<h2>Local Notification / Remote Notificationの扱い</h2>

<p>watchアプリについて、Xcode上で<code>UIRemoteNotification</code>を簡単にデバッグすることができる仕組みが用意されていますが、<code>UILocalNotification</code>についてはその限りではありません。</p>

<p><code>UIRemoteNotification</code>と<code>UILocalNotification</code>用の共通のラッパーを用意し、基本的に必要な処理はそのラッパーオブジェクトを通して行い、<code>UILocalNotification</code>であってもシミュレータ上で挙動確認ができるようにしていました。
こちらに関しては<a href="http://potatotips.connpass.com/event/28780/">potatotips #28</a>で紹介しましたので、以下スライドを参照して頂ければと思います。</p>

<div style="width: 65%">
<script async class="speakerdeck-embed" data-id="9376e6b4833343e88899900856891fc4" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>
</div>

<h2>まとめ</h2>

<p>WantedlyのApple Watch用アプリに関して、主に位置情報制御と通知周りに関して簡単に紹介しました。
Apple Watchと言えば先日、今年の6月以降にsubmitするアプリについてはwatchOS 2以降のSDKを利用しなければならないとのアナウンスがありました（参考: <a href="https://developer.apple.com/news/?id=04222016a">Upcoming Requirement for watchOS Apps</a>）。</p>

<p>今年のWWDCで何かしらのアップデートもあるでしょうし、何だかんだでwatchOS &lt;=&gt; iOS間の通信の制御は楽でもないので、この辺りが実装しやすくなることを個人的には期待したいです。</p>

<p>ということで、Watchアプリも付属しているWantedlyのiOSアプリは以下からダウンロードできます。ぜひぜひお試し下さい。</p>

<p><a href="https://itunes.apple.com/jp/app/wantedly-zhuan-zhini-shieru/id804727886?mt=8">Wantedly - 転職に使える会社訪問求人アプリ</a></p>

<h2>We are hiring</h2>

<p>WantedlyではwatchOS、iOSに限らず、多分野のエンジニアを募集しています。興味のある方はぜひ話を聞きに来て下さい。</p>

<div style="margin: 0 auto; width: 470px;">
<div class="wantedly-visit-button" data-visit-button-id="y7wE1GQEYdR11nH_D_ArCA" data-width="470" data-height="80"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "https://platform.wantedly.com/visit_buttons/script.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, "script", "wantedly-visit-buttons-wjs"));
</script>
</div>

  </div>

  <hr>
  <div>
    <a href="https://www.wantedly.com/feed/s/wantedly_engineers" alt="Wantedly Engineer Blog">Wantedly Engineer Blogは移転しました</a>
  </div>
  <hr>

  <iframe src="//www.facebook.com/plugins/like.php?href=http://engineer.wantedly.com/2016/04/30/watch-app.html&amp;width=80&amp;layout=button_count&amp;action=like&amp;show_faces=false&amp;share=false&amp;height=20&amp;appId=234170156611754", scrolling="no", frameborder="0", style="border:none; overflow:hidden; width:110px; height:20px;", allowTransparency="true"></iframe>
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="_shingt" data-url="http://engineer.wantedly.com/2016/04/30/watch-app.html">Tweet</a>
  <a href="http://b.hatena.ne.jp/entry/http://engineer.wantedly.com/2016/04/30/watch-app.html" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  
    <iframe src="http://ghbtns.com/github-btn.html?user=shingt&amp;type=follow&amp;count=true"
  allowtransparency="true" frameborder="0" scrolling="0" width="165" height="20"></iframe>
  

        </div>
        <div class="col-xs-12 col-md-3 col-md-offset-1">
          <a class="wantedly-company-feeds" data-company-id="wantedly" data-height="800" data-width="260" href="https://www.wantedly.com/companies/wantedly"></a> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://platform.wantedly.com/company_feeds/widget.js"; fjs.parentNode.insertBefore(js, fjs); }(document, "script", "wantedly-comp-feeds-wjs")); </script>
          <div class="side-article">
            <h4>最近の記事</h4>
            <ul>
              
                <li><a href="/2016/07/21/renew-engineer-blog.html">Wantedlyエンジニアブログが新しくなりました！</a></li>
              
                <li><a href="/2016/06/07/admin-night.html">管理画面チラ見せ♡ナイト#3 に登壇してきました</a></li>
              
                <li><a href="/2016/04/30/watch-app.html">Apple Watchアプリをリリースしていました</a></li>
              
                <li><a href="/2016/04/26/ui-crunch-08.html">Wantedlyのデザイン事情について UI Crunch #8で発表しました！</a></li>
              
                <li><a href="/2016/04/21/meguro-es-03.html">Wantedlyの最近のReact事情についてMeguro.es #3で発表しました!</a></li>
              
                <li><a href="/2016/04/14/reactive-swift-meetup.html">Reactive Swift Meetup @Wantedlyを開催しました！</a></li>
              
                <li><a href="/2016/04/01/four-years.html">2016年のWantedlyアーキテクチャ (1)</a></li>
              
                <li><a href="/2016/03/11/spring-internship-2016.html">Wantedly Spring Internship 2016</a></li>
              
                <li><a href="/2016/02/22/yochiyochi-python.html">よちよちPythonしてきた〜プログラミングは料理と一緒〜</a></li>
              
                <li><a href="/2016/01/24/development-camp.html">Wantedly エンジニアチームは湯河原温泉で開発合宿を行いました！</a></li>
              
            </ul>
          </div>
          <!--
            <div class="side-article">
              <h4>Tags</h4>
              <ul>
                
                  <li>- <a href="/tags/elasticsearch.html">elasticsearch</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/elasticsearch-chef-ec2-nginx.html">elasticsearch chef ec2 nginx</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/elasticsearch-chef-aws.html">elasticsearch chef aws</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/vagrant.html">vagrant</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/packer.html">packer</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/serf.html">serf</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/consul.html">consul</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/terraform.html">terraform</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/vault.html">vault</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/atlas.html">atlas</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/hashicorp.html">hashicorp</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/ios.html">iOS</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/swift.html">Swift</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/rails.html">Rails</a> <small class="gray">(3)</small></li>
                
                  <li>- <a href="/tags/angularjs.html">AngularJS</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/electron.html">Electron</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/android.html">Android</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/sketch.html">Sketch</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/ui.html">UI</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/web.html">Web</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/design.html">Design</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/sql.html">SQL</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/postgresql.html">PostgreSQL</a> <small class="gray">(2)</small></li>
                
                  <li>- <a href="/tags/development.html">Development</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/camp.html">Camp</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/yochiyochi.html">yochiyochi</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/よちよちアイドル.html">よちよちアイドル</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/インターンシップ.html">インターンシップ</a> <small class="gray">(1)</small></li>
                
                  <li>- <a href="/tags/3day-intern.html">3day intern</a> <small class="gray">(1)</small></li>
                
              </ul>
            </div>
          -->
          <!--
            <div class="side-article">
              <h4>By Year</h4>
              <ul>
                
                  <li>- <a href="/2016.html">2016</a> <small class="gray">(10)</small></li>
                
                  <li>- <a href="/2015.html">2015</a> <small class="gray">(5)</small></li>
                
                  <li>- <a href="/2014.html">2014</a> <small class="gray">(9)</small></li>
                
                  <li>- <a href="/2013.html">2013</a> <small class="gray">(2)</small></li>
                
              </ul>
            </div>
          -->
        </div>
      </div>
    </div>
    <footer class="container center">
      <hr/>
      <p>2013 © Wantedly, Inc., All Rights Reserved.</p>
    </footer>

    <script src="/javascripts/application-da39a3ee.js" type="text/javascript"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

  </body>
</html>
